@page "/AddBadge/{Id}"

@using System.Text.Json;


@inject IUserService UserService;
@inject IEarnablesService EarnablesService;
@inject NavigationManager NavigationManager

<style>
    .full-height {
        min-height: 100vh;
    }

    .centered-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
</style>




@if(isAdded)
{
    <div class="container full-height">
        <div class="row full-height centered-content">
            <div class="col-md-6 text-center">
                @if(badgeAdded && activityAdded)
                {
                   
                    <h3>Added badges and activities to @user.Name!</h3>
                    <button class="btn btn-primary" @onclick="GoToUserManagement">Back to Girl Guides</button>


                }else if (badgeAdded)
                {
                    @if (badgeCount > 1)
                    {
                        <h3>Added badges to @user.Name!</h3>
                        <button class="btn btn-primary" @onclick="GoToUserManagement">Back to Girl Guides</button>
                    }
                    else
                    {
                        <h3>Added badge to @user.Name!</h3>
                        <button class="btn btn-primary" @onclick="GoToUserManagement">Back to Girl Guides</button>
                    }
                    
                }
                else if (activityAdded)
                {
                    @if (badgeCount > 1)
                    {
                        <h3>Added activities to @user.Name!</h3>
                        <button class="btn btn-primary" @onclick="GoToUserManagement">Back to Girl Guides</button>
                    }
                    else
                    {
                        <h3>Added activity to @user.Name!</h3>
                        <button class="btn btn-primary" @onclick="GoToUserManagement">Back to Girl Guides</button>
                    }
                }
                
            </div>
        </div>
    </div>
}
else
{
    <div class="row panel">
        <div class="col">
        </div>
        <div class="col">
            <h3 class="text-center">Add Badge or Activity</h3>
        
            <Form Model="@model"

                  OnFinish="OnFinish"
                  OnFinishFailed="OnFinishFailed"
                  Size="@model.Size">
                  <div class="d-flex justify-content-center">
                        <FormItem Label="Form Size">
                            <RadioGroup @bind-Value="@context.Size">
                                <Radio RadioButton Value="@AntSizeLDSType.Small">Small</Radio>
                                <Radio RadioButton Value="@AntSizeLDSType.Default">Default</Radio>
                                <Radio RadioButton Value="@AntSizeLDSType.Large">Large</Radio>
                            </RadioGroup>
                        </FormItem>
                    </div>
            <FormItem Label="Badges">
                <Select Mode="multiple"
                    @bind-Values="@badgeSelections"
                    Placeholder="Select one or more badges"
                    TItemValue="Data.Badge"
                    TItem="Data.Badge">
                    <SelectOptions>
			            @foreach(Data.Badge badge in badges)
			            {
				            <SelectOption TItemValue="Data.Badge" TItem="Data.Badge" Value=@badge Label=@badge.Name />
			            }
		            </SelectOptions>
                </Select>
            </FormItem>
            <FormItem Label="Activities">
                <Select Mode="multiple"
                    @bind-Values="@activitySelections"
                    Placeholder="Select one or more activies"
                    TItemValue="Data.Activity"
                    TItem="Data.Activity">
                    <SelectOptions>
                        @foreach (Data.Activity activity in activities)
                        {
                                <SelectOption TItemValue="Data.Activity" TItem="Data.Activity" Value=@activity Label=@activity.Name />
                        }
                    </SelectOptions>
                </Select>
            </FormItem>

    
                <div class="d-flex justify-content-center">
                        
                            <button HtmlType="submit" class="btn btn-primary">
                                Add
                            </button>
                        
                    </div>
            </Form>
            </div>
            <div class="col">

            </div>
        </div>
}

@code {
    [Parameter]
    public string ID { get; set; }

    public class Model
    {
        public string Size { get; set; } = AntSizeLDSType.Small;
        public string Name { get; set; }
    }
    public IEnumerable<string> Names { get; set; } = Array.Empty<string>();
    private Model model = new Model();


    private List<EarnedBadge> earnedBadges = new();
    private List<CompletedActivity> completedActivities = new();
    private List<Data.Badge> badges = new();
    private List<Data.Activity> activities = new();
    private User user;
    private IEnumerable<Data.Badge> badgeSelections;
    private IEnumerable<Data.Activity> activitySelections;
    private bool isAdded = false;
    private bool badgeAdded = false;
    private bool activityAdded = false;
    private int badgeCount = 0;
    private int activityCount = 0;

    protected async override Task OnInitializedAsync()
    {
        await init();
    }

    private async Task init()
    {
        Int32.TryParse(ID, out int id);

        user = await UserService.GetUserById(id);

        earnedBadges = await EarnablesService.GetEarnedBadgesByUserId(id) ?? new();
        completedActivities = await EarnablesService.GetCompletedActivitiesByUserId(id) ?? new();

        badges = await EarnablesService.GetAllBadges();
        activities = await EarnablesService.GetAllActivities();

        foreach (EarnedBadge badge in earnedBadges)
        {
            badges.RemoveAll(b => b.Id == badge.BadgeId);
        }
        foreach (CompletedActivity activity in completedActivities)
        {
            activities.RemoveAll(b => b.Id == activity.ActivityId);
        }
    }

    private async Task OnFinish(EditContext editContext)
    {
        if (badgeSelections == null && activitySelections == null) return;

        if (badgeSelections != null)
        {
            //set bool to true 
            badgeAdded = true;
            foreach (Data.Badge badge in badgeSelections)
            {
                await UserService.AddBadgeToUser(user, badge);
                badgeCount++;
            }
        }
        if (activitySelections != null)
        {
            //set bool to true
            activityAdded = true;
            foreach (Data.Activity activity in activitySelections)
            {
                await UserService.AddActivityToUser(user, activity);
                activityCount++;
            }
        }
        isAdded = true;
        StateHasChanged();
    }

    private void OnFinishFailed(EditContext editContext)
    {
        Console.WriteLine($"Failed:{JsonSerializer.Serialize(model)}");
    }
    private void GoToUserManagement()
    {
        NavigationManager.NavigateTo("/UserManagement");
    }

}
